%macro resid_num_diag(dataset,datavar,label='requested variable',predvar=' ',predlabel='predicted variable'); title; data shortfourplotdataset; set &dataset;  label &datavar = &label;  if &datavar ne .; run; proc means data=shortfourplotdataset noprint;  var &datavar; output out=shortfourplotoutset N=nval mean=meanval; data shortfourplotoutset; set shortfourplotoutset;  xn=nval; CALL SYMPUT('nval',xn); 	xmean=meanval; CALL SYMPUT('meanval',xmean); %global nvalue; %let nvalue=&nval; %global meanvalue; %let meanvalue=&meanval; run; %if &predvar ne ' '  %then %do;     data shortfourplotdataset; set shortfourplotdataset;       label &predvar = &predlabel;     proc sort data=shortfourplotdataset out=shortfourplottemp;        by descending &predvar;     data shortfourplottemp; set shortfourplottemp;       shortfourplotorder = _n_;       shortfourplotgroup = 1-(shortfourplotorder < ceil(&nvalue/2));     proc means data=shortfourplottemp median noprint;       by shortfourplotgroup;       var &datavar;       output out=shortfourplotouttemp median=medresid;     run;    data shortfourplottempnew; merge shortfourplottemp shortfourplotouttemp; by shortfourplotgroup;       d = abs(&datavar-medresid);     run; 	run;     proc ttest data=shortfourplottempnew plots=none;       class shortfourplotgroup;       var d;       ods output TTests=shortfourplotBFtemp; title1 '(Ignore this nuisance output)'; 	run; 	run;     data shortfourplotBFtemp2; set shortfourplotBFtemp;       if method = 'Pooled';       t_BF = abs(tValue);       BF_pvalue = probt;       keep t_BF BF_pvalue;     proc print data=shortfourplotBFTemp2;       title1 'P-value for Brown-Forsythe test of constant variance'; 	  title2 'in ' &label ' vs. ' &predlabel;     run; %end; proc sort data=shortfourplotdataset out=shortfourplottemp;     by &datavar; data shortfourplottemp; set shortfourplottemp;   n=&nvalue;   expectNorm = probit((_n_-.375)/(n+.25)); proc corr data=shortfourplottemp;   var &datavar expectNorm;   title1 'Output for correlation test of normality of ' &label;   title2 '(Check text Table B.6 for threshold)'; run; title; quit; %mend resid_num_diag;
